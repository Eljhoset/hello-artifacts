name: Copy Artifact
on: [push]
env:
  SSH_AUTH_SOCK: /tmp/ssh_agent.sock
jobs:
  upload_artifact:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    name: Copy RPM using SSH
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3
      - name: Setup SSH passphrase
        env:
          SSH_PASSPHRASE: ${{secrets.SSH_PASSPHRASE}}
          SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
        run: |
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          echo 'echo $SSH_PASSPHRASE' > ~/.ssh_askpass && chmod +x ~/.ssh_askpass
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' | DISPLAY=None SSH_ASKPASS=~/.ssh_askpass ssh-add - >/dev/null
      - id: setup_ssh_host
        name: Setup SSH host
        env:
          SSH_HOST: ${{secrets.SSH_HOST}}
          SSH_PORT: ${{secrets.SSH_PORT}}
          SSH_USER: ${{secrets.SSH_USER}}
        run: |
          mkdir -p ~/.ssh/
          ssh-keyscan -p $SSH_PORT -t ed25519 $SSH_HOST >> ~/.ssh/known_hosts
          cat >>~/.ssh/config <<END
          SERVER_NAME=server
          Host $SERVER_NAME
            HostName $SSH_HOST
            User $SSH_USER
            Port $SSH_PORT
            StrictHostKeyChecking yes
          END
          echo "server_name=$SERVER_NAME\n" >> $GITHUB_OUTPUT
      - name: Setup SSH tunel
        env:
          SERVER_NAME: ${{ steps.setup_ssh_host.outputs.server_name }}
        run: |
          SERVER_PORT=8055
          ssh -fN -L $SERVER_PORT:127.0.0.1:8055 server
          echo "server_port=$SERVER_PORT\n" >> $GITHUB_OUTPUT
      - name: Print ssh-add identities
        run: ssh server ls
